<!DOCTYPE html>
<html>
<head>
  <title>Ammo Box Auto-Fill Test</title>
  <style>
    body { font-family: Arial; padding: 20px; background: #1a1a2e; color: #0ff; }
    .container { max-width: 800px; margin: 0 auto; }
    .inventory { display: flex; gap: 20px; margin: 20px 0; }
    .section { border: 2px solid #0ff; padding: 15px; flex: 1; }
    .item { background: #16213e; padding: 10px; margin: 10px 0; border: 1px solid #0ff; cursor: pointer; }
    .item:hover { background: #0f3460; }
    .locked { background: #5a2a2a !important; border-color: #ff4444; }
    .locked:hover { background: #5a2a2a !important; cursor: not-allowed; }
    button { background: #0ff; color: #000; border: none; padding: 10px 20px; margin: 5px; cursor: pointer; font-weight: bold; }
    button:hover { background: #0cc; }
    #notification { position: fixed; top: 20px; right: 20px; background: #0f3460; padding: 15px; border: 2px solid #0ff; max-width: 400px; display: none; }
    #notification.show { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .log { background: #0f3460; padding: 10px; margin: 10px 0; border-left: 3px solid #0ff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🧪 Ammo Box Auto-Fill System Test</h1>
    
    <div id="notification"></div>
    
    <div class="inventory">
      <div class="section">
        <h3>📦 Backpack Items</h3>
        <div id="backpackItems"></div>
      </div>
      
      <div class="section">
        <h3>🦺 Vest Magazine Slots</h3>
        <div id="vestSlots"></div>
      </div>
    </div>
    
    <div class="section">
      <h3>🎮 Test Actions</h3>
      <button onclick="resetTest()">Reset Test</button>
      <button onclick="setScenario1()">Scenario 1: Mixed Ammo</button>
      <button onclick="setScenario2()">Scenario 2: Empty Mags</button>
      <button onclick="setScenario3()">Scenario 3: All Full</button>
      <button onclick="setScenario4()">Scenario 4: Incompatible Types</button>
    </div>
    
    <div class="section">
      <h3>📋 Test Log</h3>
      <div id="testLog"></div>
    </div>
  </div>

  <script>
    // Simplified inventory system for testing
    const inventory = {
      magazineSlots: [],
      gridItems: []
    };
    
    let testLog = [];
    
    function showNotification(msg) {
      const notif = document.getElementById('notification');
      notif.textContent = msg;
      notif.className = 'show';
      setTimeout(() => notif.className = '', 3000);
      
      // Add to log
      const logEntry = `[${new Date().toLocaleTimeString()}] ${msg}`;
      testLog.unshift(logEntry);
      updateLog();
    }
    
    function updateLog() {
      const logDiv = document.getElementById('testLog');
      logDiv.innerHTML = testLog.slice(0, 10).map(entry => `<div class="log">${entry}</div>`).join('');
    }
    
    function isAmmoBoxLocked(ammoBox) {
      if (!ammoBox || ammoBox.type !== 'ammoBox') return false;
      if (ammoBox.amount <= 0) return false;
      
      // Check vest magazine slots
      for (let i = 0; i < inventory.magazineSlots.length; i++) {
        const mag = inventory.magazineSlots[i];
        if (mag && mag.ammoType === ammoBox.ammoType && mag.currentAmmo < mag.capacity) {
          return true;
        }
      }
      
      // Check backpack grid for magazines
      for (const gridItem of inventory.gridItems) {
        const item = gridItem.item;
        if (item.type === 'magazine' && item.ammoType === ammoBox.ammoType && item.currentAmmo < item.capacity) {
          return true;
        }
      }
      
      return false;
    }
    
    function fillMagazineWithAmmo(ammoBox, gridItemId) {
      const compatibleMags = [];
      
      // Check vest magazine slots
      for (let i = 0; i < inventory.magazineSlots.length; i++) {
        const mag = inventory.magazineSlots[i];
        if (mag && mag.ammoType === ammoBox.ammoType && mag.currentAmmo < mag.capacity) {
          compatibleMags.push({
            magazine: mag,
            location: 'vest',
            index: i,
            ammoNeeded: mag.capacity - mag.currentAmmo
          });
        }
      }
      
      // Check backpack grid for magazines
      for (const gridItem of inventory.gridItems) {
        const item = gridItem.item;
        if (item.type === 'magazine' && item.ammoType === ammoBox.ammoType && item.currentAmmo < item.capacity) {
          compatibleMags.push({
            magazine: item,
            location: 'backpack',
            gridItemId: gridItem.id,
            ammoNeeded: item.capacity - item.currentAmmo
          });
        }
      }
      
      if (compatibleMags.length === 0) {
        showNotification(`❌ No compatible ${ammoBox.ammoType} magazines found that need filling!`);
        return;
      }
      
      // Smart Prioritization: Sort by lowest ammo count first
      compatibleMags.sort((a, b) => a.magazine.currentAmmo - b.magazine.currentAmmo);
      
      // Fill magazines
      let totalRoundsFilled = 0;
      let magazinesFilled = 0;
      let remainingAmmo = ammoBox.amount;
      
      for (const magData of compatibleMags) {
        if (remainingAmmo <= 0) break;
        
        const ammoToAdd = Math.min(magData.ammoNeeded, remainingAmmo);
        magData.magazine.currentAmmo += ammoToAdd;
        remainingAmmo -= ammoToAdd;
        totalRoundsFilled += ammoToAdd;
        magazinesFilled++;
      }
      
      ammoBox.amount = remainingAmmo;
      
      let notification = `✅ Auto-filled ${magazinesFilled} magazine${magazinesFilled > 1 ? 's' : ''} with ${totalRoundsFilled} rounds`;
      
      if (remainingAmmo > 0) {
        notification += `. ${remainingAmmo} rounds remaining in box.`;
      } else {
        notification += `. Ammo box is now empty.`;
        // Remove ammo box
        const index = inventory.gridItems.findIndex(gi => gi.id === gridItemId);
        if (index !== -1) {
          inventory.gridItems.splice(index, 1);
        }
      }
      
      showNotification(notification);
      render();
    }
    
    function handleItemClick(item, gridItemId) {
      if (item.type === 'ammoBox') {
        if (isAmmoBoxLocked(item)) {
          showNotification(`🔒 Cannot move ammo box! It still has ${item.amount} rounds and compatible magazines need filling. Click to auto-fill magazines.`);
        }
        fillMagazineWithAmmo(item, gridItemId);
      }
    }
    
    function render() {
      // Render backpack items
      const backpackDiv = document.getElementById('backpackItems');
      backpackDiv.innerHTML = inventory.gridItems.map(gi => {
        const item = gi.item;
        const locked = isAmmoBoxLocked(item);
        const lockIcon = locked ? ' 🔒' : '';
        let display = `${item.icon} ${item.name}`;
        if (item.type === 'magazine') {
          display += ` (${item.currentAmmo}/${item.capacity})`;
        } else if (item.type === 'ammoBox') {
          display += ` (${item.amount}${lockIcon})`;
        }
        return `<div class="item ${locked ? 'locked' : ''}" onclick="handleItemClick(inventory.gridItems.find(g => g.id === '${gi.id}').item, '${gi.id}')">${display}</div>`;
      }).join('');
      
      // Render vest slots
      const vestDiv = document.getElementById('vestSlots');
      vestDiv.innerHTML = inventory.magazineSlots.map((mag, i) => {
        if (!mag) return `<div class="item">Empty Slot ${i + 1}</div>`;
        return `<div class="item">${mag.icon} ${mag.name} (${mag.currentAmmo}/${mag.capacity}) - ${mag.ammoType}</div>`;
      }).join('');
    }
    
    function resetTest() {
      inventory.magazineSlots = [
        { icon: '📋', name: 'Pistol Mag', capacity: 15, currentAmmo: 15, ammoType: 'pistol' },
        { icon: '📋', name: 'Pistol Mag', capacity: 15, currentAmmo: 15, ammoType: 'pistol' },
        { icon: '📋', name: 'Pistol Mag', capacity: 15, currentAmmo: 15, ammoType: 'pistol' }
      ];
      inventory.gridItems = [];
      testLog = [];
      showNotification('🔄 Test reset to initial state');
      render();
    }
    
    function setScenario1() {
      inventory.magazineSlots = [
        { icon: '📋', name: 'Pistol Mag', capacity: 15, currentAmmo: 3, ammoType: 'pistol', type: 'magazine' },
        { icon: '📋', name: 'Pistol Mag', capacity: 15, currentAmmo: 5, ammoType: 'pistol', type: 'magazine' },
        { icon: '📋', name: 'Pistol Mag', capacity: 15, currentAmmo: 8, ammoType: 'pistol', type: 'magazine' }
      ];
      inventory.gridItems = [
        {
          id: 'ammo1',
          item: { icon: '📦', name: 'Pistol Ammo Box', amount: 30, ammoType: 'pistol', type: 'ammoBox' }
        },
        {
          id: 'mag1',
          item: { icon: '📋', name: 'Pistol Mag', capacity: 15, currentAmmo: 10, ammoType: 'pistol', type: 'magazine' }
        }
      ];
      showNotification('📋 Scenario 1: Mixed ammo levels (3, 5, 8, 10) + 30 round box');
      render();
    }
    
    function setScenario2() {
      inventory.magazineSlots = [
        { icon: '📋', name: 'Pistol Mag', capacity: 15, currentAmmo: 0, ammoType: 'pistol', type: 'magazine' },
        { icon: '📋', name: 'Pistol Mag', capacity: 15, currentAmmo: 0, ammoType: 'pistol', type: 'magazine' },
        { icon: '📋', name: 'Rifle Mag', capacity: 30, currentAmmo: 0, ammoType: 'rifle', type: 'magazine' }
      ];
      inventory.gridItems = [
        {
          id: 'ammo1',
          item: { icon: '📦', name: 'Pistol Ammo Box', amount: 60, ammoType: 'pistol', type: 'ammoBox' }
        }
      ];
      showNotification('📋 Scenario 2: Empty magazines (2x pistol, 1x rifle) + 60 pistol rounds');
      render();
    }
    
    function setScenario3() {
      inventory.magazineSlots = [
        { icon: '📋', name: 'Pistol Mag', capacity: 15, currentAmmo: 15, ammoType: 'pistol', type: 'magazine' },
        { icon: '📋', name: 'Pistol Mag', capacity: 15, currentAmmo: 15, ammoType: 'pistol', type: 'magazine' },
        { icon: '📋', name: 'Pistol Mag', capacity: 15, currentAmmo: 15, ammoType: 'pistol', type: 'magazine' }
      ];
      inventory.gridItems = [
        {
          id: 'ammo1',
          item: { icon: '📦', name: 'Pistol Ammo Box', amount: 30, ammoType: 'pistol', type: 'ammoBox' }
        }
      ];
      showNotification('📋 Scenario 3: All magazines full + ammo box (should show error)');
      render();
    }
    
    function setScenario4() {
      inventory.magazineSlots = [
        { icon: '📋', name: 'Rifle Mag', capacity: 30, currentAmmo: 10, ammoType: 'rifle', type: 'magazine' },
        { icon: '📋', name: 'Rifle Mag', capacity: 30, currentAmmo: 5, ammoType: 'rifle', type: 'magazine' },
        { icon: '📋', name: 'Sniper Mag', capacity: 5, currentAmmo: 2, ammoType: 'sniper', type: 'magazine' }
      ];
      inventory.gridItems = [
        {
          id: 'ammo1',
          item: { icon: '📦', name: 'Pistol Ammo Box', amount: 30, ammoType: 'pistol', type: 'ammoBox' }
        }
      ];
      showNotification('📋 Scenario 4: Incompatible types (pistol ammo, rifle/sniper mags)');
      render();
    }
    
    // Initialize
    resetTest();
  </script>
</body>
</html>
